<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Blog The Lizards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: calc(100vh - 200px);
        }
        
        .editor-panel {
            padding: 30px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .preview-panel {
            padding: 30px;
            background: #f8f9fa;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .section-title {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.95em;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="file"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 250px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }
        
        .image-preview {
            margin-top: 10px;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .image-preview.has-image {
            border-color: #28a745;
            background: #f0f9f4;
        }
        
        .toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .toolbar button {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .toolbar button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .publish-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .publish-section h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .publish-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .publish-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .publish-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .preview-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .preview-content h1 {
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .preview-content .post-meta {
            color: #666;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.95em;
        }
        
        .preview-content .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .preview-content .post-body {
            line-height: 1.8;
            color: #333;
        }
        
        .preview-content .post-body h2 {
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .preview-content .post-body h3 {
            color: #764ba2;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 1.2em;
        }
        
        .preview-content .post-body p {
            margin-bottom: 15px;
        }
        
        .preview-content .post-body ul,
        .preview-content .post-body ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }
        
        .preview-content .post-body li {
            margin-bottom: 8px;
        }
        
        .preview-content .post-body strong {
            font-weight: 600;
        }
        
        .preview-content .post-body em {
            font-style: italic;
        }
        
        .preview-content .post-body a {
            color: #667eea;
            text-decoration: none;
        }
        
        .preview-content .post-body a:hover {
            text-decoration: underline;
        }
        
        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé∏ Editor Blog The Lizards</h1>
            <p>Crea e pubblica post in un solo posto</p>
        </header>
        
        <div class="main-content">
            <!-- PANNELLO EDITOR -->
            <div class="editor-panel">
                <h2 class="section-title">‚úèÔ∏è Scrivi il tuo Post</h2>
                
                <div class="alert alert-info">
                    <strong>üí° Come funziona:</strong> Compila i campi, vedi l'anteprima in tempo reale. Quando sei pronto, inserisci la password e pubblica tutto insieme!
                </div>
                
                <!-- UPLOAD IMMAGINE -->
                <div class="form-group">
                    <label for="image">üì∏ Immagine del Post (opzionale)</label>
                    <input type="file" id="image" accept="image/jpeg,image/jpg,image/png">
                    <div class="image-preview" id="imagePreview">
                        <p style="color: #999;">Seleziona un'immagine per vedere l'anteprima</p>
                    </div>
                    <p class="help-text">Formati: JPG, PNG. L'immagine verr√† ottimizzata automaticamente (max 900x600px, WebP ~30-40KB)</p>
                </div>
                
                <!-- METADATI POST -->
                <div class="form-group">
                    <label for="title">üìå Titolo del Post *</label>
                    <input type="text" id="title" placeholder="es: Nuovo Concerto a Milano" required>
                </div>
                
                <div class="form-group">
                    <label for="date">üìÖ Data di Pubblicazione *</label>
                    <input type="date" id="date" required>
                    <p class="help-text">‚è∞ Puoi impostare una data futura per programmare la pubblicazione</p>
                </div>
                
                <!-- EDITOR CONTENUTO -->
                <div class="form-group">
                    <label for="content">‚úçÔ∏è Contenuto del Post *</label>
                    <div class="toolbar">
                        <button type="button" onclick="insertMarkdown('**', '**')" title="Grassetto"><strong>B</strong></button>
                        <button type="button" onclick="insertMarkdown('*', '*')" title="Corsivo"><em>I</em></button>
                        <button type="button" onclick="insertMarkdown('## ', '')" title="Titolo H2">H2</button>
                        <button type="button" onclick="insertMarkdown('### ', '')" title="Titolo H3">H3</button>
                        <button type="button" onclick="insertMarkdown('[', '](url)')" title="Link">üîó Link</button>
                        <button type="button" onclick="insertMarkdown('- ', '')" title="Lista">‚Ä¢ Lista</button>
                        <button type="button" onclick="insertMarkdown('<!--more-->\n\n', '')" title="Separa anteprima">‚úÇÔ∏è Anteprima</button>
                    </div>
                    <textarea id="content" placeholder="Scrivi qui il contenuto del post usando Markdown...

Esempio:
Siamo entusiasti di annunciare il nostro prossimo concerto!

<!--more-->

Il **20 dicembre 2025** saremo al Fabrique di Milano per una serata speciale dedicata ai Cranberries.

## Dettagli dell'Evento

- **Data**: 20 Dicembre 2025
- **Luogo**: Fabrique, Milano  
- **Biglietti**: Disponibili su TicketOne

Vi aspettiamo numerosi! üéµ"></textarea>
                    <p class="help-text">
                        üí° Usa <code>&lt;!--more--&gt;</code> per separare l'anteprima dal resto del contenuto. <br>
                        Usa <strong>**testo**</strong> per grassetto, <em>*testo*</em> per corsivo, <code>## Titolo</code> per i titoli.
                    </p>
                </div>
                
                <!-- SEZIONE PUBBLICAZIONE -->
                <div class="publish-section">
                    <h3>üöÄ Pubblica</h3>
                    <div class="form-group">
                        <label for="password">üîê Password</label>
                        <input type="password" id="password" placeholder="Inserisci la password per pubblicare">
                        <p class="help-text">Richiedi la password al team tecnico se non ce l'hai</p>
                    </div>
                    
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>Pubblicazione in corso...</p>
                    </div>
                    
                    <div id="message"></div>
                    
                    <button class="publish-btn" id="publishBtn" onclick="publishPost()">
                        üì§ Pubblica Post + Immagine
                    </button>
                </div>
            </div>
            
            <!-- PANNELLO PREVIEW -->
            <div class="preview-panel">
                <h2 class="section-title">üëÅÔ∏è Anteprima</h2>
                
                <div class="preview-content" id="previewContent">
                    <h1 id="previewTitle">Titolo del Post</h1>
                    <div class="post-meta">
                        üìÖ <span id="previewDate">--/--/----</span>
                    </div>
                    <img id="previewImage" class="post-image" style="display: none;" src="" alt="">
                    <div class="post-body" id="previewBody">
                        <p style="color: #999; font-style: italic;">L'anteprima apparir√† qui mentre scrivi...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // CONFIGURAZIONE
        const CLOUDFLARE_WORKER_URL = 'https://thelizards-blog-upload.lizberries.workers.dev';
        
        // Auto-update preview
        document.getElementById('title').addEventListener('input', updatePreview);
        document.getElementById('date').addEventListener('change', updatePreview);
        document.getElementById('content').addEventListener('input', updatePreview);
        
        // Variabile per salvare il file immagine
        let selectedImageFile = null;
        let selectedImageName = null;
        
        // Image preview
        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedImageFile = file;
                selectedImageName = file.name.replace(/\.(jpg|jpeg|png)$/i, '.webp');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `
                        <p style="color: #28a745; font-weight: bold;">‚úÖ Immagine selezionata</p>
                        <p style="font-size: 0.9em;">${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
                        <img src="${e.target.result}" alt="Preview">
                        <p style="font-size: 0.85em; color: #666; margin-top: 10px;">Verr√† caricata come: ${selectedImageName}</p>
                    `;
                    preview.classList.add('has-image');
                    
                    // Update preview panel
                    const previewImg = document.getElementById('previewImage');
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                selectedImageFile = null;
                selectedImageName = null;
                document.getElementById('previewImage').style.display = 'none';
            }
        });
        
        function updatePreview() {
            const title = document.getElementById('title').value || 'Titolo del Post';
            const date = document.getElementById('date').value;
            const content = document.getElementById('content').value;
            
            // Update title
            document.getElementById('previewTitle').textContent = title;
            
            // Update date
            if (date) {
                const dateObj = new Date(date + 'T00:00:00');
                const formatted = dateObj.toLocaleDateString('it-IT', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('previewDate').textContent = formatted;
            }
            
            // Update content (basic markdown rendering)
            if (content) {
                let html = content
                    // Headers
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    // Bold
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    // Italic
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    // Links
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                    // Lists
                    .replace(/^- (.+)$/gm, '<li>$1</li>');
                
                // Wrap paragraphs
                html = html.split('\n\n').map(p => {
                    p = p.trim();
                    if (!p) return '';
                    if (p.startsWith('<h') || p.startsWith('<li>') || p.includes('<!--more-->')) return p;
                    return `<p>${p}</p>`;
                }).join('\n');
                
                // Wrap lists
                html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
                
                // Handle <!--more--> separator
                if (html.includes('<!--more-->')) {
                    const parts = html.split('<!--more-->');
                    html = parts[0] + 
                           '<hr style="margin: 30px 0; border: 2px solid #667eea;">' +
                           '<p style="color: #667eea; font-style: italic;">‚Üì Contenuto completo ‚Üì</p>' +
                           parts[1];
                }
                
                document.getElementById('previewBody').innerHTML = html;
            } else {
                document.getElementById('previewBody').innerHTML = 
                    '<p style="color: #999; font-style: italic;">L\'anteprima apparir√† qui mentre scrivi...</p>';
            }
        }
        
        function insertMarkdown(before, after) {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            
            const newText = text.substring(0, start) + 
                           before + selectedText + after + 
                           text.substring(end);
            
            textarea.value = newText;
            textarea.focus();
            textarea.selectionStart = start + before.length;
            textarea.selectionEnd = start + before.length + selectedText.length;
            
            updatePreview();
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function slugify(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/[^a-z0-9]+/g, '-') // Replace non-alphanumeric with -
                .replace(/^-+|-+$/g, ''); // Remove leading/trailing -
        }
        
        async function publishPost() {
            const password = document.getElementById('password').value;
            const title = document.getElementById('title').value;
            const date = document.getElementById('date').value;
            const content = document.getElementById('content').value;
            
            // Validation
            if (!password) {
                showMessage('Inserisci la password', 'error');
                return;
            }
            if (!title) {
                showMessage('Inserisci il titolo del post', 'error');
                return;
            }
            if (!date) {
                showMessage('Seleziona la data di pubblicazione', 'error');
                return;
            }
            if (!content) {
                showMessage('Scrivi il contenuto del post', 'error');
                return;
            }
            
            // Disable button and show loading
            const publishBtn = document.getElementById('publishBtn');
            publishBtn.disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('message').innerHTML = '';
            
            try {
                let imageWebpName = null;
                
                // Step 1: Upload image if selected
                if (selectedImageFile) {
                    showMessage('Caricamento immagine...', 'info');
                    
                    const imageBase64 = await fileToBase64(selectedImageFile);
                    const imageResponse = await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'upload_image',
                            password: password,
                            filename: selectedImageFile.name,
                            fileContent: imageBase64
                        })
                    });
                    
                    const imageData = await imageResponse.json();
                    if (!imageResponse.ok || !imageData.success) {
                        throw new Error(imageData.error || 'Errore nel caricamento dell\'immagine');
                    }
                    
                    imageWebpName = imageData.webpName;
                }
                
                // Step 2: Create post
                showMessage('Creazione post...', 'info');
                
                const postFilename = `${date}-${slugify(title)}.md`;
                
                // Build front matter
                let frontMatter = `---\nlayout: post\ntitle: "${title}"\ndate: ${date}\n`;
                if (imageWebpName) {
                    frontMatter += `image: /assets/images/posts/${imageWebpName}\n`;
                }
                frontMatter += `---\n\n`;
                
                const postContent = frontMatter + content;
                
                const postResponse = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create_post',
                        password: password,
                        filename: postFilename,
                        content: postContent
                    })
                });
                
                const postData = await postResponse.json();
                if (!postResponse.ok || !postData.success) {
                    throw new Error(postData.error || 'Errore nella creazione del post');
                }
                
                // Success!
                showMessage(
                    `‚úÖ <strong>Post pubblicato con successo!</strong><br><br>` +
                    `üìÑ File: <code>${postFilename}</code><br>` +
                    (imageWebpName ? `üñºÔ∏è Immagine: <code>${imageWebpName}</code><br>` : '') +
                    `<br>‚è≥ Il post apparir√† sul blog tra 1-2 minuti.<br>` +
                    `üåç Dopo altri 1-2 minuti sar√† tradotto automaticamente in inglese.`,
                    'success'
                );
                
                // Reset form
                document.getElementById('title').value = '';
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('content').value = '';
                document.getElementById('image').value = '';
                document.getElementById('password').value = '';
                document.getElementById('imagePreview').innerHTML = '<p style="color: #999;">Seleziona un\'immagine per vedere l\'anteprima</p>';
                document.getElementById('imagePreview').classList.remove('has-image');
                selectedImageFile = null;
                selectedImageName = null;
                updatePreview();
                
            } catch (error) {
                console.error('Publish error:', error);
                showMessage(`‚ùå <strong>Errore:</strong> ${error.message}`, 'error');
            } finally {
                publishBtn.disabled = false;
                document.getElementById('loading').classList.remove('active');
            }
        }
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
        }
        
        // Set default date to today
        document.getElementById('date').valueAsDate = new Date();
        updatePreview();
    </script>
</body>
</html>
